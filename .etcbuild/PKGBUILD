# vim:ft=bash

pkgbase=system-meta-pkgs
pkgname=('base-system' 'kahve-system' 'warana-system')
arch=('x86_64')
pkgver=0
pkgrel="$(date +%s)"
source=(
	# base
	locale.conf
	locale.gen
	mkinitcpio-linux.preset
	mkinitcpio-linux-lts.preset
	systemd-base-system.preset
	systemd-flatpak-update.service
	systemd-flatpak-update.timer
	systemd-networkd-wait-online-override.conf
	journald.conf
	oomd-slice-oom-kill.conf
	networkd-ipv6-privacy-extensions.conf
	firewalld-service-localsend.xml
	firewalld-service-jellyfin.xml
	tlp-performance.conf
	sshd-hardened.conf
	greetd-config.toml
	sway-uwsm.desktop
	reflector.conf
	sudoers
	pacman-dashbinsh.hook
	pacman-paccache-1.hook
	pacman-paccache-2.hook
	pacman-systemd-boot.hook
	pacman.conf

	# shared
	networkd-home-ether.network
	networkd-home-wlan.network
	networkd-uni-ether.network
	networkd-uni-wlan.network

	# kahve
	mkinitcpio-kahve-hooks.conf
	systemd-kahve-system.preset

	# warana
	cmdline-warana-resume.conf
	cmdline-warana-rootflags.conf
	mkinitcpio-warana-hooks.conf
	systemd-warana-system.preset
	logind-power-key-hibernate.conf
	tlp-battery-care.conf
)
cksums=($(yes 'SKIP' | head -n "${#source[@]}"))

package_base-system() {
	install='base-system.install'
	depends=(
		base linux linux-lts linux-firmware mkinitcpio systemd-ukify

		# services
		tlp
		reflector

		# network services
		firewalld firewall-config
		tailscale
		openssh
		cups cups-pdf

		# login manager
		greetd greetd-tuigreet

		# sway session
		uwsm sway swaybg swayidle swaylock
		waybar j4-dmenu-desktop wmenu
		brightnessctl playerctl mako slurp grim swappy
		xdg-desktop-portal-gtk xdg-desktop-portal-wlr
		libnotify cliphist
		wl-clipboard xdg-utils mailcap
		xorg-xwayland
		kanshi

		# fonts
		terminus-font
		inter-font
		ttf-jetbrains-mono ttf-nerd-fonts-symbols-mono
		noto-fonts noto-fonts-cjk noto-fonts-emoji

		# themes and icons
		gnome-themes-extra
		adwaita-icon-theme breeze-icons hicolor-icon-theme

		# sound system
		pipewire pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse
		wireplumber
		easyeffects calf lsp-plugins-lv2 jalv # calf for bass enhancer. lsp-plugins-lv2 for equalizer, needs lv2-host which is provided by jalv, see: https://gitlab.archlinux.org/archlinux/packaging/packages/mda.lv2/-/issues/1
		gstreamer gst-plugin-pipewire gst-plugin-va

		# password dialogs
		lxqt-policykit                    # polkit
		lxqt-openssh-askpass              # ssh
		pinentry kguiaddons kwindowsystem # gnupg

		# applications
		flatpak
		foot foot-terminfo
		neovim inotify-tools tree-sitter-cli # inotify-tools for lsp file watcher, tree-sitter-cli for nvim-treesitter plugin
		nautilus
		thunderbird hunspell-en_us # don't forget hunspell-pt-br from AUR

		# other dependencies
		polkit rtkit

		# shell
		dash
		bash bash-completion
		zsh zsh-completions zsh-syntax-highlighting
		tmux

		# shell tools
		sudo
		man-db man-pages
		less stdoutisatty
		fzf fd ripgrep ripgrep-all
		tree gdu
		chafa
		htop bpftop
		bpftrace
		pandoc-cli
		ffmpeg
		efibootmgr
		rclone
		sshfs

		# dev tools
		base-devel
		git git-lfs difftastic
		jq sqlite zola miniserve
		make gdb strace

		# network tools
		iproute2 ethtool iptables-nft   # configure
		iputils nmap curl               # poke
		ldns whois                      # query
		tcpdump tcpreplay wireshark-cli # capture

		# filesystems tools
		btrfs-progs dosfstools exfatprogs veracrypt

		# languages
		gcc clang
		rustup
		python uv

		# language servers, linters, formatters
		bash-language-server shellcheck shfmt
		ruff ty
		stylua
		marksman markdownlint-cli2
		texlab

		# keys and passwords
		gnupg
		pass pass-otp

		# latex
		texlive-meta texlive-langenglish texlive-langportuguese
		perl-yaml-tiny perl-file-homedir # for latexindent

		# virtualization
		virt-manager
		libvirt qemu-full dmidecode dnsmasq openbsd-netcat

		# containers
		podman
		docker docker-buildx

		# maintenance
		archlinux-contrib
		pacman-contrib
		rebuild-detector
		lostfiles
		fwupd
	)

	install -Dm0644 locale.conf "$pkgdir"/etc/locale.conf
	install -Dm0644 locale.gen "$pkgdir"/etc/locale.gen

	echo 'quiet' | install -Dm0644 /dev/stdin "$pkgdir"/etc/cmdline.d/quiet.conf
	install -Dm0644 mkinitcpio-linux.preset "$pkgdir"/etc/mkinitcpio.d/linux.preset
	install -Dm0644 mkinitcpio-linux-lts.preset "$pkgdir"/etc/mkinitcpio.d/linux-lts.preset

	install -Dm0644 systemd-base-system.preset "$pkgdir"/etc/systemd/system-preset/80-base-system.preset
	echo 'disable *' | install -Dm0644 /dev/stdin "$pkgdir"/etc/systemd/user-preset/99-default.preset

	install -Dm0644 systemd-flatpak-update.service "$pkgdir"/etc/systemd/system/flatpak-update.service
	install -Dm0644 systemd-flatpak-update.timer "$pkgdir"/etc/systemd/system/flatpak-update.timer
	install -Dm0644 systemd-networkd-wait-online-override.conf "$pkgdir"/etc/systemd/system/systemd-networkd-wait-online.service.d/override.conf

	install -Dm0644 journald.conf "$pkgdir"/etc/systemd/journald.conf.d/override.conf

	install -Dm0644 oomd-slice-oom-kill.conf "$pkgdir"/etc/systemd/system/user.slice.d/10-oom-kill.conf
	install -Dm0644 oomd-slice-oom-kill.conf "$pkgdir"/etc/systemd/system/system.slice.d/10-oom-kill.conf

	install -Dm0644 networkd-ipv6-privacy-extensions.conf "$pkgdir"/etc/systemd/networkd.conf.d/ipv6-privacy-extensions.conf

	install -Dm0644 firewalld-service-localsend.xml "$pkgdir"/etc/firewalld/services/localsend.xml
	install -Dm0644 firewalld-service-jellyfin.xml "$pkgdir"/etc/firewalld/services/jellyfin.xml

	install -Dm0644 tlp-performance.conf "$pkgdir"/etc/tlp.d/10-performance.conf

	install -Dm0644 sshd-hardened.conf "$pkgdir"/etc/ssh/sshd_config.d/20-hardened.conf

	install -Dm0644 greetd-config.toml "$pkgdir"/etc/greetd/config.toml
	install -Dm0644 sway-uwsm.desktop "$pkgdir"/usr/share/wayland-sessions/sway-uwsm.desktop

	install -Dm0644 reflector.conf "$pkgdir"/etc/xdg/reflector/reflector.conf

	install -dm0750 "$pkgdir"/etc/sudoers.d
	install -Dm0440 sudoers "$pkgdir"/etc/sudoers.d/10-defaults

	install -Dm0644 pacman-dashbinsh.hook "$pkgdir"/etc/pacman.d/hooks/dashbinsh.hook
	install -Dm0644 pacman-paccache-1.hook "$pkgdir"/etc/pacman.d/hooks/paccache-1.hook
	install -Dm0644 pacman-paccache-2.hook "$pkgdir"/etc/pacman.d/hooks/paccache-2.hook
	install -Dm0644 pacman-systemd-boot.hook "$pkgdir"/etc/pacman.d/hooks/95-systemd-boot.hook
	install -Dm0644 pacman.conf "$pkgdir"/etc/pacman.conf
}

package_kahve-system() {
	depends=(
		base-system
		amd-ucode mesa sof-firmware
		iwd wireless-regdb
		bluez bluez-utils blueman
	)

	echo 'kahve' | install -Dm0644 /dev/stdin "$pkgdir"/etc/hostname
	echo 'FONT=ter-v18n' | install -Dm0644 /dev/stdin "$pkgdir"/etc/vconsole.conf
	echo 'processor.max_cstate=5' | install -Dm0644 /dev/stdin "$pkgdir"/etc/cmdline.d/max_cstate.conf

	install -Dm0644 mkinitcpio-kahve-hooks.conf "$pkgdir"/etc/mkinitcpio.conf.d/hooks.conf

	install -Dm0644 systemd-kahve-system.preset "$pkgdir"/etc/systemd/system-preset/70-kahve-system.preset

	echo 'WIRELESS_REGDOM="BR"' | install -Dm0644 /dev/stdin "$pkgdir"/etc/conf.d/wireless-regdom
	install -Dm0644 networkd-uni-ether.network "$pkgdir"/etc/systemd/network/20-uni-ether.network
	install -Dm0644 networkd-uni-wlan.network "$pkgdir"/etc/systemd/network/20-uni-wlan.network
}

package_warana-system() {
	depends=(
		base-system
		intel-ucode mesa vulkan-intel intel-media-driver sof-firmware
		iwd wireless-regdb
		bluez bluez-utils blueman
		cryptsetup sbctl fprintd
		snapper snap-pac
	)

	echo 'warana' | install -Dm0644 /dev/stdin "$pkgdir"/etc/hostname
	echo 'FONT=ter-v24n' | install -Dm0644 /dev/stdin "$pkgdir"/etc/vconsole.conf

	echo 'options i915 enable_guc=3' | install -Dm0644 /dev/stdin "$pkgdir"/etc/modprobe.d/i915.conf
	install -Dm0644 cmdline-warana-resume.conf "$pkgdir"/etc/cmdline.d/resume.conf
	install -Dm0644 cmdline-warana-rootflags.conf "$pkgdir"/etc/cmdline.d/rootflags.conf
	install -Dm0644 mkinitcpio-warana-hooks.conf "$pkgdir"/etc/mkinitcpio.conf.d/hooks.conf

	install -Dm0644 systemd-warana-system.preset "$pkgdir"/etc/systemd/system-preset/70-warana-system.preset

	echo 'WIRELESS_REGDOM="BR"' | install -Dm0644 /dev/stdin "$pkgdir"/etc/conf.d/wireless-regdom
	install -Dm0644 networkd-home-ether.network "$pkgdir"/etc/systemd/network/20-home-ether.network
	install -Dm0644 networkd-home-wlan.network "$pkgdir"/etc/systemd/network/20-home-wlan.network

	install -Dm0644 logind-power-key-hibernate.conf "$pkgdir"/etc/systemd/logind.conf.d/power-key-hibernate.conf

	install -Dm0644 tlp-battery-care.conf "$pkgdir"/etc/tlp.d/20-battery-care.conf
}
